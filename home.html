<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Data Transfer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .mode-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .mode-btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            background: #e0e0e0;
            color: #333;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .input-area {
            margin-bottom: 20px;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            resize: vertical;
            min-height: 120px;
            font-family: inherit;
        }

        .file-upload {
            margin: 20px 0;
            padding: 30px;
            border: 3px dashed #667eea;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .file-upload input {
            display: none;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }

        input[type="range"] {
            width: 100%;
        }

        .control-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-top: 10px;
        }

        .control-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .qr-container {
            background: white;
            padding: 40px;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            max-width: 700px;
        }

        #qr-display {
            background: white;
        }

        #qr-display canvas {
            display: block !important;
        }

        .frame-info {
            text-align: center;
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            border-radius: 10px;
            color: white;
            text-align: center;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 600;
            margin-top: 5px;
        }

        .video-container {
            position: relative;
            max-width: 100%;
            margin: 20px auto;
        }

        #video {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 10px;
            border: 4px solid #333;
        }

        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            border: 3px solid #4caf50;
            border-radius: 10px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }

        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }

        .preview-container {
            margin: 20px 0;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
            min-height: 200px;
        }

        .preview-container img {
            max-width: 100%;
            border-radius: 10px;
        }

        .preview-container pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: 600;
            text-align: center;
            background: #e0e0e0;
            color: #666;
        }

        .status.active {
            background: #4caf50;
            color: white;
            animation: pulse 2s infinite;
        }

        .status.scanning {
            background: #2196f3;
            color: white;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .log {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.85em;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }

        #scan-canvas {
            display: none;
        }

        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            font-weight: 600;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .alert.warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± QR Data Transfer</h1>
        
        <div class="mode-selector">
            <button class="mode-btn active" onclick="setMode('transmit')">üíª Transmit (Laptop)</button>
            <button class="mode-btn" onclick="setMode('receive')">üì± Receive (Phone)</button>
        </div>

        <div id="transmit-section" class="section active">
            <div class="input-area">
                <textarea id="text-input" placeholder="Enter text to transmit...">Hello World from QR codes!</textarea>
            </div>

            <div class="file-upload" onclick="document.getElementById('file-input').click()">
                <input type="file" id="file-input" onchange="handleFileSelect(event)" accept="image/*,text/*,.pdf,.json">
                <p>üìÅ Click to upload a file</p>
                <p style="font-size: 0.9em; color: #999; margin-top: 5px;">Images, text files (max 200KB recommended)</p>
                <p id="file-name" style="margin-top: 10px; color: #667eea; font-weight: 600;"></p>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>Display Time per QR (seconds): <span id="delay-value">2.0</span></label>
                    <input type="range" id="delay-slider" min="1" max="4" step="0.5" value="2" oninput="updateDelay(this.value)">
                </div>
                <div class="control-group">
                    <label>Bytes per QR: <span id="chunk-value">500</span></label>
                    <input type="range" id="chunk-slider" min="300" max="1000" step="100" value="500" oninput="updateChunkSize(this.value)">
                </div>
            </div>

            <button class="control-btn" onclick="startTransmission()">üöÄ Start Transmission</button>

            <div class="status" id="transmit-status">Ready to transmit</div>

            <div class="frame-info" id="frame-info" style="display: none;"></div>

            <div class="qr-container">
                <div id="qr-display">
                    <p style="color: #999; padding: 100px 50px; text-align: center;">QR codes will appear here</p>
                </div>
            </div>

            <div class="stats" id="transmit-stats" style="display: none;">
                <div class="stat-item">
                    <div class="stat-label">Total Bytes</div>
                    <div class="stat-value" id="total-bytes">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Total QR Codes</div>
                    <div class="stat-value" id="total-qrs">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Current</div>
                    <div class="stat-value" id="current-qr">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Progress</div>
                    <div class="stat-value" id="progress-percent">0%</div>
                </div>
            </div>
        </div>

        <div id="receive-section" class="section">
            <div class="info-box">
                <strong>üì± Instructions:</strong><br>
                1. Set transmitter running on laptop first<br>
                2. Click "Start Camera" below<br>
                3. Point phone camera at QR codes<br>
                4. Keep phone STEADY in the green box area<br>
                5. Brightness should be HIGH on laptop<br>
                6. Distance: 20-40cm from screen
            </div>

            <button class="control-btn" id="camera-btn" onclick="toggleCamera()">üì∑ Start Camera</button>

            <div class="status" id="receive-status">Camera not started</div>

            <div id="scan-alert"></div>

            <div class="video-container">
                <video id="video" autoplay playsinline></video>
                <div class="scan-overlay"></div>
            </div>

            <canvas id="scan-canvas"></canvas>

            <div class="progress-bar">
                <div class="progress-fill" id="receive-progress" style="width: 0%">0%</div>
            </div>

            <div class="stats" id="receive-stats" style="display: none;">
                <div class="stat-item">
                    <div class="stat-label">Received</div>
                    <div class="stat-value" id="received-bytes">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Expected</div>
                    <div class="stat-value" id="expected-bytes">?</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">QR Codes Got</div>
                    <div class="stat-value" id="qrs-scanned">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Completion</div>
                    <div class="stat-value" id="success-rate">0%</div>
                </div>
            </div>

            <div class="log" id="log"></div>

            <div class="preview-container" id="receive-preview">
                <p style="text-align: center; color: #999;">Received data will appear here...</p>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'transmit';
        let transmitting = false;
        let receiving = false;
        let fileData = null;
        let fileName = null;
        let fileType = null;
        
        // Transmission
        let displayDelay = 2.0;
        let chunkSize = 500;
        let transmitTimeout = null;
        let currentQRIndex = 0;
        let qrCodes = [];
        
        // Reception
        let scanInterval = null;
        let receivedChunks = {};
        let totalChunks = 0;
        let dataLength = 0;
        let receivedDataType = null;
        let scannedQRs = new Set();
        let lastScanTime = 0;

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            
            if (mode === 'transmit') {
                document.querySelectorAll('.mode-btn')[0].classList.add('active');
                document.getElementById('transmit-section').classList.add('active');
            } else {
                document.querySelectorAll('.mode-btn')[1].classList.add('active');
                document.getElementById('receive-section').classList.add('active');
            }
        }

        function updateDelay(value) {
            displayDelay = parseFloat(value);
            document.getElementById('delay-value').textContent = displayDelay.toFixed(1);
        }

        function updateChunkSize(value) {
            chunkSize = parseInt(value);
            document.getElementById('chunk-value').textContent = chunkSize;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 500000) {
                alert('File too large! Please use files under 500KB for reliable transfer');
                return;
            }

            fileName = file.name;
            fileType = file.type;
            document.getElementById('file-name').textContent = `Selected: ${fileName} (${(file.size / 1024).toFixed(1)} KB)`;

            const reader = new FileReader();
            reader.onload = function(e) {
                fileData = new Uint8Array(e.target.result);
            };
            reader.readAsArrayBuffer(file);
        }

        function startTransmission() {
            if (transmitting) {
                stopTransmission();
                return;
            }

            const textInput = document.getElementById('text-input').value;
            let dataToSend;
            let dataType = 'text';

            if (fileData) {
                dataToSend = fileData;
                dataType = fileType || 'application/octet-stream';
            } else if (textInput) {
                dataToSend = new TextEncoder().encode(textInput);
                dataType = 'text/plain';
            } else {
                alert('Please enter text or select a file');
                return;
            }

            qrCodes = createQRCodes(dataToSend, dataType);
            currentQRIndex = 0;
            
            transmitting = true;
            document.querySelector('#transmit-section .control-btn').textContent = '‚èπÔ∏è Stop Transmission';
            document.getElementById('transmit-status').textContent = 'Transmitting...';
            document.getElementById('transmit-status').className = 'status active';
            document.getElementById('transmit-stats').style.display = 'grid';
            document.getElementById('frame-info').style.display = 'block';
            document.getElementById('total-bytes').textContent = dataToSend.length;
            document.getElementById('total-qrs').textContent = qrCodes.length;
            
            displayNextQR();
        }

        function stopTransmission() {
            transmitting = false;
            clearTimeout(transmitTimeout);
            document.querySelector('#transmit-section .control-btn').textContent = 'üöÄ Start Transmission';
            document.getElementById('transmit-status').textContent = 'Stopped';
            document.getElementById('transmit-status').className = 'status';
            document.getElementById('frame-info').style.display = 'none';
        }

        function createQRCodes(data, dataType) {
            const codes = [];
            
            const header = {
                len: data.length,
                type: dataType,
                chunks: Math.ceil(data.length / chunkSize)
            };
            const headerStr = JSON.stringify(header);
            codes.push({ index: 0, data: headerStr, isHeader: true });
            
            for (let i = 0; i < data.length; i += chunkSize) {
                const chunk = data.slice(i, Math.min(i + chunkSize, data.length));
                const chunkIndex = Math.floor(i / chunkSize) + 1;
                
                const base64 = arrayBufferToBase64(chunk);
                const payload = JSON.stringify({
                    i: chunkIndex,
                    d: base64
                });
                
                codes.push({ index: chunkIndex, data: payload, isHeader: false });
            }
            
            return codes;
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.length; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        function base64ToArrayBuffer(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes;
        }

        function displayNextQR() {
            if (!transmitting) return;

            if (currentQRIndex >= qrCodes.length) {
                currentQRIndex = 0;
            }

            const qrData = qrCodes[currentQRIndex];
            const display = document.getElementById('qr-display');
            display.innerHTML = '';
            
            const frameInfo = document.getElementById('frame-info');
            if (qrData.isHeader) {
                frameInfo.textContent = 'üìã HEADER';
                frameInfo.style.background = '#fff3cd';
            } else {
                frameInfo.textContent = `QR ${qrData.index} of ${qrCodes.length - 1}`;
                frameInfo.style.background = '#d4edda';
            }
            
            try {
                new QRCode(display, {
                    text: qrData.data,
                    width: 512,
                    height: 512,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            } catch (e) {
                console.error('QR generation error:', e);
            }
            
            document.getElementById('current-qr').textContent = `${currentQRIndex + 1}/${qrCodes.length}`;
            const progress = ((currentQRIndex + 1) / qrCodes.length * 100).toFixed(0);
            document.getElementById('progress-percent').textContent = progress + '%';
            
            currentQRIndex++;
            transmitTimeout = setTimeout(displayNextQR, displayDelay * 1000);
        }

        async function toggleCamera() {
            if (receiving) {
                stopCamera();
            } else {
                await startCamera();
            }
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                });
                
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                await new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });
                
                receiving = true;
                document.getElementById('camera-btn').textContent = '‚èπÔ∏è Stop Camera';
                document.getElementById('receive-status').textContent = 'Scanning...';
                document.getElementById('receive-status').className = 'status scanning';
                document.getElementById('receive-stats').style.display = 'grid';
                
                receivedChunks = {};
                totalChunks = 0;
                dataLength = 0;
                scannedQRs = new Set();
                
                scanInterval = setInterval(scanQR, 200);
                
                log('üì∑ Camera ready - point at QR codes');
                showAlert('Position your camera over the QR code', 'warning');
            } catch (err) {
                alert('Camera error: ' + err.message);
                log('‚ùå ERROR: ' + err.message);
            }
        }

        function stopCamera() {
            receiving = false;
            clearInterval(scanInterval);
            
            const video = document.getElementById('video');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            document.getElementById('camera-btn').textContent = 'üì∑ Start Camera';
            document.getElementById('receive-status').textContent = 'Stopped';
            document.getElementById('receive-status').className = 'status';
        }

        function scanQR() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('scan-canvas');
            
            if (video.readyState !== video.HAVE_ENOUGH_DATA) return;
            
            const now = Date.now();
            if (now - lastScanTime < 150) return;
            lastScanTime = now;
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });
            
            if (code) {
                processQRCode(code.data);
            }
        }

        function processQRCode(data) {
            try {
                const parsed = JSON.parse(data);
                
                if (parsed.len !== undefined) {
                    dataLength = parsed.len;
                    receivedDataType = parsed.type;
                    totalChunks = parsed.chunks;
                    
                    if (!receivedChunks[0]) {
                        receivedChunks[0] = { isHeader: true };
                        document.getElementById('expected-bytes').textContent = dataLength;
                        log(`üìã Header received: ${dataLength} bytes, ${totalChunks} chunks`);
                        showAlert('Header received! Keep scanning...', 'success');
                    }
                } 
                else if (parsed.i !== undefined && parsed.d !== undefined) {
                    const index = parsed.i;
                    
                    if (!scannedQRs.has(index)) {
                        scannedQRs.add(index);
                        
                        const chunkData = base64ToArrayBuffer(parsed.d);
                        receivedChunks[index] = { data: chunkData };
                        
                        const scanned = scannedQRs.size;
                        document.getElementById('qrs-scanned').textContent = scanned;
                        
                        if (totalChunks > 0) {
                            const rate = ((scanned / totalChunks) * 100).toFixed(0);
                            document.getElementById('success-rate').textContent = rate + '%';
                        }
                        
                        log(`‚úì QR ${index}/${totalChunks} scanned`);
                        
                        if (scanned % 5 === 0) {
                            showAlert(`${scanned} of ${totalChunks} QR codes received`, 'success');
                        }
                        
                        reconstructData();
                    }
                }
                
            } catch (e) {
                // Invalid QR data
            }
        }

        function reconstructData() {
            if (totalChunks === 0 || dataLength === 0) return;
            
            const chunkIndices = Object.keys(receivedChunks)
                .map(k => parseInt(k))
                .filter(k => k > 0)
                .sort((a, b) => a - b);
            
            if (chunkIndices.length === 0) return;
            
            const allBytes = [];
            for (const index of chunkIndices) {
                const chunk = receivedChunks[index];
                if (chunk && chunk.data) {
                    allBytes.push(...chunk.data);
                }
            }
            
            const receivedBytes = Math.min(allBytes.length, dataLength);
            document.getElementById('received-bytes').textContent = receivedBytes;
            
            if (dataLength > 0) {
                const progress = Math.min(100, (receivedBytes / dataLength * 100));
                document.getElementById('receive-progress').style.width = progress + '%';
                document.getElementById('receive-progress').textContent = progress.toFixed(0) + '%';
            }
            
            if (receivedBytes > 0) {
                const data = new Uint8Array(allBytes.slice(0, dataLength));
                displayReceivedData(data);
            }
            
            if (receivedBytes >= dataLength && scannedQRs.size >= totalChunks) {
                document.getElementById('receive-status').textContent = '‚úì Transfer Complete!';
                document.getElementById('receive-status').className = 'status active';
                log('üéâ Transfer complete!');
                showAlert('Transfer complete! Data received successfully!', 'success');
            }
        }

        function displayReceivedData(data) {
            const preview = document.getElementById('receive-preview');
            preview.innerHTML = '';
            
            if (receivedDataType && receivedDataType.startsWith('image/')) {
                const blob = new Blob([data], { type: receivedDataType });
                const url = URL.createObjectURL(blob);
                const img = document.createElement('img');
                img.src = url;
                img.style.maxWidth = '100%';
                img.onload = () => log('üñºÔ∏è Image rendered!');
                preview.appendChild(img);
            } else {
                try {
                    const text = new TextDecoder().decode(data);
                    const pre = document.createElement('pre');
                    pre.textContent = text;
                    preview.appendChild(pre);
                } catch (e) {
                    preview.innerHTML = `<p>üì¶ Binary data (${data.length} bytes)</p>`;
                }
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.getElementById('scan-alert');
            alertDiv.innerHTML = `<div class="alert ${type}">${message}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 3000);
        }

        function log(message) {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${time}] ${message}<br>`;
            logEl.scrollTop = logEl.scrollHeight;
            
            const lines = logEl.innerHTML.split('<br>');
            if (lines.length > 100) {
                logEl.innerHTML = lines.slice(lines.length - 100).join('<br>');
            }
        }
    </script>
</body>
</html>
