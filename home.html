<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Data Transfer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .mode-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .mode-btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            background: #e0e0e0;
            color: #333;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .input-area {
            margin-bottom: 20px;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            resize: vertical;
            min-height: 120px;
            font-family: inherit;
        }

        .file-upload {
            margin: 20px 0;
            padding: 30px;
            border: 3px dashed #667eea;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .file-upload input {
            display: none;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }

        input[type="range"] {
            width: 100%;
        }

        .control-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-top: 10px;
        }

        .control-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #qr-display {
            width: 600px;
            height: 600px;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 8px solid #333;
            border-radius: 10px;
            position: relative;
        }

        #qr-display canvas {
            max-width: 100%;
            max-height: 100%;
        }

        .frame-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: 600;
            font-size: 1.2em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            border-radius: 10px;
            color: white;
            text-align: center;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 600;
            margin-top: 5px;
        }

        .video-container {
            position: relative;
            max-width: 640px;
            margin: 20px auto;
        }

        #video {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 10px;
            border: 4px solid #333;
        }

        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }

        .preview-container {
            margin: 20px 0;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
            min-height: 200px;
        }

        .preview-container img {
            max-width: 100%;
            border-radius: 10px;
        }

        .preview-container pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: 600;
            text-align: center;
            background: #e0e0e0;
            color: #666;
        }

        .status.active {
            background: #4caf50;
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .log {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.85em;
            max-height: 150px;
            overflow-y: auto;
            margin: 10px 0;
        }

        #scan-canvas {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± QR Data Transfer</h1>
        
        <div class="mode-selector">
            <button class="mode-btn active" onclick="setMode('transmit')">üíª Transmit (Laptop)</button>
            <button class="mode-btn" onclick="setMode('receive')">üì± Receive (Phone)</button>
        </div>

        <!-- Transmit Section -->
        <div id="transmit-section" class="section active">
            <div class="input-area">
                <textarea id="text-input" placeholder="Enter text to transmit...">Hello from QR codes!</textarea>
            </div>

            <div class="file-upload" onclick="document.getElementById('file-input').click()">
                <input type="file" id="file-input" onchange="handleFileSelect(event)">
                <p>üìÅ Click to upload a file (images, text, small files)</p>
                <p id="file-name" style="margin-top: 10px; color: #667eea; font-weight: 600;"></p>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>Display Time per QR (seconds): <span id="delay-value">1.5</span></label>
                    <input type="range" id="delay-slider" min="0.5" max="3" step="0.1" value="1.5" oninput="updateDelay(this.value)">
                </div>
                <div class="control-group">
                    <label>Chunk Size (bytes): <span id="chunk-value">800</span></label>
                    <input type="range" id="chunk-slider" min="400" max="1500" step="100" value="800" oninput="updateChunkSize(this.value)">
                </div>
            </div>

            <button class="control-btn" onclick="startTransmission()">üöÄ Start Transmission</button>

            <div class="status" id="transmit-status">Ready to transmit</div>

            <div id="qr-display">
                <p style="color: #999;">QR codes will appear here</p>
            </div>

            <div class="stats" id="transmit-stats" style="display: none;">
                <div class="stat-item">
                    <div class="stat-label">Total Bytes</div>
                    <div class="stat-value" id="total-bytes">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">QR Codes</div>
                    <div class="stat-value" id="total-qrs">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Current QR</div>
                    <div class="stat-value" id="current-qr">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Progress</div>
                    <div class="stat-value" id="progress-percent">0%</div>
                </div>
            </div>
        </div>

        <!-- Receive Section -->
        <div id="receive-section" class="section">
            <div class="info-box">
                <strong>üì± Instructions:</strong><br>
                1. Click "Start Camera" and allow camera access<br>
                2. Point camera at the QR codes on laptop screen<br>
                3. Keep camera steady and screen brightness HIGH<br>
                4. System will automatically scan each QR code<br>
                5. Data appears live below as it's received!
            </div>

            <button class="control-btn" id="camera-btn" onclick="toggleCamera()">üì∑ Start Camera</button>

            <div class="status" id="receive-status">Camera not started</div>

            <div class="video-container">
                <video id="video" autoplay playsinline></video>
            </div>

            <canvas id="scan-canvas"></canvas>

            <div class="log" id="log"></div>

            <div class="progress-bar">
                <div class="progress-fill" id="receive-progress" style="width: 0%">0%</div>
            </div>

            <div class="stats" id="receive-stats" style="display: none;">
                <div class="stat-item">
                    <div class="stat-label">Received</div>
                    <div class="stat-value" id="received-bytes">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Expected</div>
                    <div class="stat-value" id="expected-bytes">?</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">QR Scanned</div>
                    <div class="stat-value" id="qrs-scanned">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Success Rate</div>
                    <div class="stat-value" id="success-rate">0%</div>
                </div>
            </div>

            <div class="preview-container" id="receive-preview">
                <p style="text-align: center; color: #999;">Received data will appear here...</p>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'transmit';
        let transmitting = false;
        let receiving = false;
        let fileData = null;
        let fileName = null;
        let fileType = null;
        
        // Transmission
        let displayDelay = 1.5;
        let chunkSize = 800;
        let transmitInterval = null;
        let currentQRIndex = 0;
        let qrCodes = [];
        
        // Reception
        let scanInterval = null;
        let receivedChunks = {};
        let totalChunks = 0;
        let dataLength = 0;
        let receivedDataType = null;
        let lastScannedIndex = -1;

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            
            if (mode === 'transmit') {
                document.querySelectorAll('.mode-btn')[0].classList.add('active');
                document.getElementById('transmit-section').classList.add('active');
            } else {
                document.querySelectorAll('.mode-btn')[1].classList.add('active');
                document.getElementById('receive-section').classList.add('active');
            }
        }

        function updateDelay(value) {
            displayDelay = parseFloat(value);
            document.getElementById('delay-value').textContent = displayDelay.toFixed(1);
        }

        function updateChunkSize(value) {
            chunkSize = parseInt(value);
            document.getElementById('chunk-value').textContent = chunkSize;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 500000) {
                alert('File too large! Please use files under 500KB');
                return;
            }

            fileName = file.name;
            fileType = file.type;
            document.getElementById('file-name').textContent = `Selected: ${fileName} (${(file.size / 1024).toFixed(1)} KB)`;

            const reader = new FileReader();
            reader.onload = function(e) {
                fileData = new Uint8Array(e.target.result);
            };
            reader.readAsArrayBuffer(file);
        }

        function startTransmission() {
            if (transmitting) {
                stopTransmission();
                return;
            }

            const textInput = document.getElementById('text-input').value;
            let dataToSend;
            let dataType = 'text';

            if (fileData) {
                dataToSend = fileData;
                dataType = fileType || 'application/octet-stream';
            } else if (textInput) {
                dataToSend = new TextEncoder().encode(textInput);
                dataType = 'text/plain';
            } else {
                alert('Please enter text or select a file');
                return;
            }

            // Create QR codes
            qrCodes = createQRCodes(dataToSend, dataType);
            currentQRIndex = 0;
            
            transmitting = true;
            document.querySelector('#transmit-section .control-btn').textContent = '‚èπÔ∏è Stop Transmission';
            document.getElementById('transmit-status').textContent = 'Transmitting...';
            document.getElementById('transmit-status').className = 'status active';
            document.getElementById('transmit-stats').style.display = 'grid';
            document.getElementById('total-bytes').textContent = dataToSend.length;
            document.getElementById('total-qrs').textContent = qrCodes.length;
            
            displayNextQR();
        }

        function stopTransmission() {
            transmitting = false;
            clearTimeout(transmitInterval);
            document.querySelector('#transmit-section .control-btn').textContent = 'üöÄ Start Transmission';
            document.getElementById('transmit-status').textContent = 'Stopped';
            document.getElementById('transmit-status').className = 'status';
        }

        function createQRCodes(data, dataType) {
            const codes = [];
            
            // Create header
            const header = {
                len: data.length,
                type: dataType,
                chunks: Math.ceil(data.length / chunkSize)
            };
            const headerStr = JSON.stringify(header);
            codes.push({ index: 0, data: headerStr, isHeader: true });
            
            // Create data chunks
            for (let i = 0; i < data.length; i += chunkSize) {
                const chunk = data.slice(i, i + chunkSize);
                const chunkIndex = Math.floor(i / chunkSize) + 1;
                
                // Convert to base64 for QR encoding
                const base64 = arrayBufferToBase64(chunk);
                const payload = JSON.stringify({
                    i: chunkIndex,
                    d: base64
                });
                
                codes.push({ index: chunkIndex, data: payload, isHeader: false });
            }
            
            return codes;
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.length; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        function base64ToArrayBuffer(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes;
        }

        function displayNextQR() {
            if (!transmitting || currentQRIndex >= qrCodes.length) {
                if (transmitting) {
                    currentQRIndex = 0; // Loop
                } else {
                    return;
                }
            }

            const qrData = qrCodes[currentQRIndex];
            const display = document.getElementById('qr-display');
            display.innerHTML = '';
            
            // Create frame indicator
            const indicator = document.createElement('div');
            indicator.className = 'frame-indicator';
            indicator.textContent = qrData.isHeader ? 'HEADER' : `${qrData.index}/${qrCodes.length - 1}`;
            display.appendChild(indicator);
            
            // Generate QR code
            new QRCode(display, {
                text: qrData.data,
                width: 550,
                height: 550,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.M
            });
            
            document.getElementById('current-qr').textContent = `${currentQRIndex + 1}/${qrCodes.length}`;
            const progress = ((currentQRIndex + 1) / qrCodes.length * 100).toFixed(0);
            document.getElementById('progress-percent').textContent = progress + '%';
            
            currentQRIndex++;
            
            transmitInterval = setTimeout(displayNextQR, displayDelay * 1000);
        }

        // RECEIVER
        async function toggleCamera() {
            if (receiving) {
                stopCamera();
            } else {
                await startCamera();
            }
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                });
                
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                await new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });
                
                receiving = true;
                document.getElementById('camera-btn').textContent = '‚èπÔ∏è Stop Camera';
                document.getElementById('receive-status').textContent = 'Scanning for QR codes...';
                document.getElementById('receive-status').className = 'status active';
                document.getElementById('receive-stats').style.display = 'grid';
                
                receivedChunks = {};
                totalChunks = 0;
                dataLength = 0;
                lastScannedIndex = -1;
                
                scanInterval = setInterval(scanQR, 100);
                
                log('Camera started, scanning...');
            } catch (err) {
                alert('Camera error: ' + err.message);
                log('ERROR: ' + err.message);
            }
        }

        function stopCamera() {
            receiving = false;
            clearInterval(scanInterval);
            
            const video = document.getElementById('video');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            document.getElementById('camera-btn').textContent = 'üì∑ Start Camera';
            document.getElementById('receive-status').textContent = 'Stopped';
            document.getElementById('receive-status').className = 'status';
        }

        function scanQR() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('scan-canvas');
            
            if (video.readyState !== video.HAVE_ENOUGH_DATA) return;
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });
            
            if (code) {
                processQRCode(code.data);
            }
        }

        function processQRCode(data) {
            try {
                const parsed = JSON.parse(data);
                
                // Check if header
                if (parsed.len !== undefined) {
                    dataLength = parsed.len;
                    receivedDataType = parsed.type;
                    totalChunks = parsed.chunks;
                    
                    document.getElementById('expected-bytes').textContent = dataLength;
                    log(`Header: ${dataLength} bytes, ${totalChunks} chunks`);
                    receivedChunks[0] = { isHeader: true };
                } 
                // Data chunk
                else if (parsed.i !== undefined && parsed.d !== undefined) {
                    const index = parsed.i;
                    
                    // Avoid re-scanning same QR
                    if (index === lastScannedIndex) return;
                    lastScannedIndex = index;
                    
                    if (!receivedChunks[index]) {
                        const chunkData = base64ToArrayBuffer(parsed.d);
                        receivedChunks[index] = { data: chunkData };
                        
                        const scanned = Object.keys(receivedChunks).length - 1; // -1 for header
                        document.getElementById('qrs-scanned').textContent = scanned;
                        
                        if (totalChunks > 0) {
                            const rate = ((scanned / totalChunks) * 100).toFixed(0);
                            document.getElementById('success-rate').textContent = rate + '%';
                        }
                        
                        log(`Chunk ${index}/${totalChunks} received`);
                        reconstructData();
                    }
                }
                
                // Reset after small delay to allow next scan
                setTimeout(() => { lastScannedIndex = -1; }, 200);
                
            } catch (e) {
                // Invalid QR data
            }
        }

        function reconstructData() {
            if (totalChunks === 0 || dataLength === 0) return;
            
            // Check how many chunks we have
            const chunkIndices = Object.keys(receivedChunks)
                .map(k => parseInt(k))
                .filter(k => k > 0)
                .sort((a, b) => a - b);
            
            if (chunkIndices.length === 0) return;
            
            // Concatenate chunks
            const allBytes = [];
            for (const index of chunkIndices) {
                const chunk = receivedChunks[index];
                if (chunk && chunk.data) {
                    allBytes.push(...chunk.data);
                }
            }
            
            const receivedBytes = Math.min(allBytes.length, dataLength);
            document.getElementById('received-bytes').textContent = receivedBytes;
            
            if (dataLength > 0) {
                const progress = Math.min(100, (receivedBytes / dataLength * 100));
                document.getElementById('receive-progress').style.width = progress + '%';
                document.getElementById('receive-progress').textContent = progress.toFixed(0) + '%';
            }
            
            // Display data
            if (receivedBytes > 0) {
                const data = new Uint8Array(allBytes.slice(0, dataLength));
                displayReceivedData(data);
            }
            
            if (receivedBytes >= dataLength) {
                document.getElementById('receive-status').textContent = 'Transfer complete!';
                document.getElementById('receive-status').className = 'status';
                log('‚úì Transfer complete!');
            }
        }

        function displayReceivedData(data) {
            const preview = document.getElementById('receive-preview');
            preview.innerHTML = '';
            
            if (receivedDataType && receivedDataType.startsWith('image/')) {
                const blob = new Blob([data], { type: receivedDataType });
                const url = URL.createObjectURL(blob);
                const img = document.createElement('img');
                img.src = url;
                img.style.maxWidth = '100%';
                img.onload = () => log('Image rendered!');
                preview.appendChild(img);
            } else {
                try {
                    const text = new TextDecoder().decode(data);
                    const pre = document.createElement('pre');
                    pre.textContent = text;
                    preview.appendChild(pre);
                } catch (e) {
                    preview.innerHTML = `<p>Binary data (${data.length} bytes)</p>`;
                }
            }
        }

        function log(message) {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${time}] ${message}<br>`;
            logEl.scrollTop = logEl.scrollHeight;
            
            const lines = logEl.innerHTML.split('<br>');
            if (lines.length > 8) {
                logEl.innerHTML = lines.slice(-8).join('<br>');
            }
        }
    </script>
</body>
</html>
